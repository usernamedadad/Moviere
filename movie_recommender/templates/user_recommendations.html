{% extends 'base.html' %}

{% block title %}我的推荐 - 电影推荐系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>个性化电影推荐</h2>
        <p class="text-muted">基于您的评分历史和相似用户的喜好</p>
        
        <div class="user-id-form">
            <div class="form-inline">
                <div class="form-group">
                    <label for="user-id">用户ID: </label>
                    <input type="number" class="form-control" id="user-id" 
                           placeholder="输入用户ID" min="1" value="{{ user_id }}">
                </div>
                <button id="get-recommendations" class="btn btn-primary">
                    <i class="fa fa-magic"></i> 获取推荐
                </button>
                <button id="refresh-recommendations" class="btn btn-info">
                    <i class="fa fa-refresh"></i> 刷新推荐
                </button>
            </div>
        </div>
        
        <div id="recommendations-loading" class="loading" style="display: none;">
            <i class="fa fa-spinner fa-spin fa-3x"></i>
            <p>正在生成个性化推荐...</p>
        </div>
        
        <div id="recommendations-results" style="display: none;">
            <h3>为您推荐的电影</h3>
            <div class="row recommendations-container">
                <!-- 推荐结果将通过JavaScript动态加载 -->
            </div>
        </div>
        
        <div id="initial-state" class="text-center" style="padding: 40px;">
            <i class="fa fa-film fa-5x text-muted" style="margin-bottom: 20px;"></i>
            <h4 class="text-muted">请输入用户ID并点击"获取推荐"</h4>
            <p class="text-muted">系统将基于协同过滤算法为您生成个性化电影推荐</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 从localStorage加载用户ID
    var savedUserId = localStorage.getItem('userId');
    if (savedUserId) {
        $('#user-id').val(savedUserId);
        $('#get-recommendations').click(); // 自动获取推荐
    }
});

// 更新显示推荐结果的函数
function displayRecommendations(data) {
    var $results = $('#recommendations-results');
    var $container = $results.find('.recommendations-container');
    
    $container.empty();
    
    if (data.recommended_movies_details && data.recommended_movies_details.length > 0) {
        data.recommended_movies_details.forEach(function(movie, index) {
            // 确定电影类型类名
            var typeClass = 'default';
            if (movie.genres) {
                if (movie.genres.includes('Comedy')) typeClass = 'comedy';
                else if (movie.genres.includes('Action')) typeClass = 'action';
                else if (movie.genres.includes('Drama')) typeClass = 'drama';
                else if (movie.genres.includes('Romance')) typeClass = 'romance';
                else if (movie.genres.includes('Horror')) typeClass = 'horror';
                else if (movie.genres.includes('Children') || movie.genres.includes('Animation')) typeClass = 'children';
                else if (movie.genres.includes('Sci-Fi')) typeClass = 'scifi';
                else if (movie.genres.includes('Documentary')) typeClass = 'documentary';
            }
            
            var movieHtml = `
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="movie-card">
                        <div class="movie-poster ${typeClass}">
                            <i class="fa fa-film"></i>
                        </div>
                        <div class="movie-info">
                            <div class="movie-title">${movie.title}</div>
                            <div class="movie-genres">
                                ${movie.genres ? movie.genres.split('|').slice(0, 3).map(genre => 
                                    `<span class="genre-tag">${genre}</span>`
                                ).join('') : '<span class="genre-tag">未知类型</span>'}
                            </div>
                            <div class="recommendation-badge">推荐 #${index + 1}</div>
                            <div class="rating-section">
                                <div id="rating-${movie.movie_id}" class="text-muted small" style="margin-bottom: 8px;"></div>
                                <div class="rating-controls">
                                    <small class="rating-label">评分:</small>
                                    ${[1,2,3,4,5].map(star => `
                                        <button class="btn btn-rating" 
                                                data-rating="${star}" data-movie-id="${movie.movie_id}">
                                            ${star} <i class="fa fa-star"></i>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $container.append(movieHtml);
        });
    } else {
        $container.html('<div class="col-12"><div class="alert alert-info">暂无推荐结果</div></div>');
    }
    
    $results.show();
    
    // 重新绑定评分按钮事件
    $('.btn-rating').off('click').on('click', function() {
        var rating = $(this).data('rating');
        var movieId = $(this).data('movie-id');
        var userId = $('#user-id').val() || localStorage.getItem('userId') || 1;
        
        rateMovie(userId, movieId, rating, $(this));
    });
}
</script>
{% endblock %}