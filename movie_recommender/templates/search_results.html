{% extends 'base.html' %}

{% block title %}搜索结果 - 电影推荐系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>搜索结果</h2>
        
        <!-- 搜索框 -->
        <div class="search-form">
            <form action="{% url 'search_movies' %}" method="get" class="form-inline">
                <div class="form-group">
                    <input type="text" name="q" class="form-control" placeholder="搜索电影名称..." 
                           value="{{ query }}" style="width: 300px;">
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-search"></i> 搜索
                </button>
                <a href="{% url 'movie_list' %}" class="btn btn-default">返回电影库</a>
            </form>
        </div>

        <!-- 搜索结果统计 -->
        <div class="search-info" style="margin: 20px 0;">
            {% if query %}
                <p class="text-muted">
                    <i class="fa fa-info-circle"></i> 
                    搜索 "<strong>{{ query }}</strong>" 找到 <span id="result-count">0</span> 部电影
                </p>
            {% else %}
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle"></i> 请输入搜索关键词
                </div>
            {% endif %}
        </div>

        <input type="hidden" id="user-id" value="{{ user_id }}">
        
        <!-- 搜索结果容器 -->
        <div id="search-results">
            <div class="loading" id="search-loading" style="display: none;">
                <i class="fa fa-spinner fa-spin fa-3x"></i>
                <p>正在搜索电影...</p>
            </div>
            
            <div id="movies-container">
                <!-- 电影将通过JavaScript动态加载 -->
            </div>
        </div>

        <!-- 初始状态或空结果 -->
        <div id="initial-state" class="text-center" style="padding: 60px 20px;">
            <i class="fa fa-search fa-5x text-muted" style="margin-bottom: 20px;"></i>
            <h4 class="text-muted">输入电影名称开始搜索</h4>
            <p class="text-muted">搜索您感兴趣的电影并进行评分</p>
        </div>

        <!-- 无结果提示 -->
        <div id="no-results" class="text-center" style="padding: 60px 20px; display: none;">
            <i class="fa fa-film fa-5x text-muted" style="margin-bottom: 20px;"></i>
            <h4 class="text-muted">未找到相关电影</h4>
            <p class="text-muted">尝试使用其他关键词搜索，或浏览<a href="{% url 'movie_list' %}">全部电影</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 从localStorage加载用户ID
    var savedUserId = localStorage.getItem('userId');
    if (savedUserId) {
        $('#user-id').val(savedUserId);
    }

    // 如果有搜索关键词，自动执行搜索
    var searchQuery = "{{ query }}";
    if (searchQuery) {
        performSearch(searchQuery);
    }

    // 搜索表单提交
    $('form').on('submit', function(e) {
        e.preventDefault();
        var query = $('input[name="q"]').val().trim();
        if (query) {
            // 更新URL但不刷新页面
            var newUrl = "{% url 'search_movies' %}?q=" + encodeURIComponent(query);
            window.history.pushState({}, '', newUrl);
            performSearch(query);
        }
    });

    // 输入框实时搜索（防抖）
    var searchTimeout;
    $('input[name="q"]').on('input', function() {
        var query = $(this).val().trim();
        clearTimeout(searchTimeout);
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(function() {
                performSearch(query);
            }, 500);
        } else if (query.length === 0) {
            showInitialState();
        }
    });
});

function performSearch(query) {
    console.log('执行搜索:', query);
    
    // 显示加载状态
    $('#search-loading').show();
    $('#movies-container').empty();
    $('#initial-state').hide();
    $('#no-results').hide();
    
    $.ajax({
        url: '/api/movies/search/',
        method: 'GET',
        data: {
            'q': query
        },
        success: function(movies) {
            console.log('搜索结果:', movies);
            displaySearchResults(movies, query);
        },
        error: function(xhr) {
            console.error('搜索失败:', xhr);
            showAlert('搜索失败，请重试', 'error');
        },
        complete: function() {
            $('#search-loading').hide();
        }
    });
}

function displaySearchResults(movies, query) {
    var $container = $('#movies-container');
    var $resultCount = $('#result-count');
    
    $container.empty();
    
    if (movies && movies.length > 0) {
        // 更新结果计数
        $resultCount.text(movies.length);
        
        // 显示电影卡片
        var html = '<div class="row">';
        movies.forEach(function(movie) {
            // 确定电影类型类名
            var typeClass = 'default';
            if (movie.genres) {
                if (movie.genres.includes('Comedy')) typeClass = 'comedy';
                else if (movie.genres.includes('Action')) typeClass = 'action';
                else if (movie.genres.includes('Drama')) typeClass = 'drama';
                else if (movie.genres.includes('Romance')) typeClass = 'romance';
                else if (movie.genres.includes('Horror')) typeClass = 'horror';
                else if (movie.genres.includes('Children') || movie.genres.includes('Animation')) typeClass = 'children';
                else if (movie.genres.includes('Sci-Fi')) typeClass = 'scifi';
                else if (movie.genres.includes('Documentary')) typeClass = 'documentary';
            }
            
            // 高亮搜索关键词
            var highlightedTitle = movie.title;
            if (query) {
                var regex = new RegExp('(' + query + ')', 'gi');
                highlightedTitle = movie.title.replace(regex, '<mark>$1</mark>');
            }
            
            html += `
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="movie-card">
                        <div class="movie-poster ${typeClass}">
                            <i class="fa fa-film"></i>
                        </div>
                        <div class="movie-info">
                            <div class="movie-title">${highlightedTitle}</div>
                            <div class="movie-genres">
                                ${movie.genres ? movie.genres.split('|').slice(0, 3).map(genre => 
                                    `<span class="genre-tag">${genre}</span>`
                                ).join('') : '<span class="genre-tag">未知类型</span>'}
                            </div>
                            <div id="rating-${movie.movie_id}" class="text-muted small" style="margin-bottom: 8px;"></div>
                            <div class="rating-section">
                                <div class="rating-controls">
                                    <small class="rating-label">评分:</small>
                                    ${[1,2,3,4,5].map(star => `
                                        <button class="btn btn-rating" 
                                                data-rating="${star}" data-movie-id="${movie.movie_id}">
                                            ${star} <i class="fa fa-star"></i>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        $container.html(html);
        
        // 隐藏初始状态
        $('#initial-state').hide();
        $('#no-results').hide();
        
    } else {
        // 没有结果
        $resultCount.text('0');
        $('#no-results').show();
        $('#initial-state').hide();
    }
    
    // 重新绑定评分按钮事件
    $('.btn-rating').off('click').on('click', function() {
        var rating = $(this).data('rating');
        var movieId = $(this).data('movie-id');
        var userId = $('#user-id').val() || localStorage.getItem('userId') || 1;
        
        rateMovie(userId, movieId, rating, $(this));
    });
}

function showInitialState() {
    $('#movies-container').empty();
    $('#initial-state').show();
    $('#no-results').hide();
    $('#result-count').text('0');
}

// 使用main.js中定义的rateMovie函数
// 确保main.js在search_results.html之前加载
</script>

<style>
/* 搜索页面特定样式 */
.search-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 15px 20px;
    border-radius: 12px;
    border-left: 4px solid #2196f3;
    color: #1565c0;
}

mark {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: bold;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .search-form .form-control {
        width: 100% !important;
        margin-bottom: 10px;
    }
    
    .search-form .btn {
        margin-bottom: 10px;
    }
}
</style>
{% endblock %}